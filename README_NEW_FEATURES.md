# Новый функционал: Фильтрация по дате и сохранение в Excel

## Описание

Добавлен новый режим работы программы с возможностью:
1. **Фильтрации проблем по дате** - обработка только тех проблем, которые были активны в указанную дату
2. **Сохранения результатов в исходный Excel файл** - добавление колонки "потерянные" в таблицу "Свод_по_заметкам"

## Новые флаги

### `--date-filter`
Включает режим фильтрации по дате. При запуске программа запросит у пользователя дату в формате ДД.ММ.ГГГГ.

**Пример:**
```bash
python main.py data.xlsx --date-filter
```

### `--save-to-excel`
Сохраняет результаты в исходный Excel файл в таблицу "Свод_по_заметкам" в колонку "потерянные".

**Пример:**
```bash
python main.py data.xlsx --date-filter --save-to-excel
```

## Логика работы

### Фильтрация по дате
Программа обрабатывает только те проблемы, которые:
- Были открыты до или в указанную дату (`Старт <= конец дня`)
- Были закрыты после или в указанную дату (`Окончание >= начало дня`) или не закрыты (`Окончание is null`)

### Временные окна
В новом режиме для каждой проблемы создается **одно временное окно** для указанной даты:

1. **Проблема открыта в указанную дату:**
   - Начало: время открытия проблемы
   - Окончание: время закрытия или конец дня

2. **Проблема открыта раньше, но активна в указанную дату:**
   - Начало: 00:00 указанной даты
   - Окончание: время закрытия или конец дня

3. **Проблема не закрыта:**
   - Начало: время открытия или 00:00 указанной даты
   - Окончание: 23:59 указанной даты

### Сохранение в Excel
Результаты сохраняются в исходный файл:
- Лист: "Отчет"
- Таблица: "Свод_по_заметкам"
- Колонка: "потерянные" (создается автоматически если не существует)

## Примеры использования

### Стандартный режим (без изменений)
```bash
python main.py data.xlsx --out-csv results.csv
```

### Новый режим с фильтрацией по дате
```bash
python main.py data.xlsx --date-filter
```
Программа запросит дату и обработает только проблемы для этой даты, сохранив результаты в CSV.

### Новый режим с сохранением в Excel
```bash
python main.py data.xlsx --date-filter --save-to-excel
```
Программа запросит дату, обработает проблемы и сохранит результаты в исходный Excel файл.

### Комбинирование с другими флагами
```bash
python main.py data.xlsx --date-filter --save-to-excel --with-skills --no-headless
```

## Структура файлов

### Новые модули
- `modules/excel_manager.py` - работа с Excel файлами, фильтрация по дате

### Обновленные модули
- `main.py` - добавлены новые флаги и логика переключения режимов

## Тестирование

Для тестирования нового функционала используйте:
```bash
python test_new_functionality.py
```

## Совместимость

- ✅ Полностью сохранен исходный функционал
- ✅ Новый функционал доступен только по флагам
- ✅ Обратная совместимость со старыми командами

# Новые возможности скрипта

## Автоматическая обработка по дате (--auto-date-processing)

### Описание
Новый режим работы скрипта, который автоматически определяет дату из первой строки данных в Excel файле и обрабатывает только строки с этой датой.

### Как работает
1. **Автоматическое определение даты**: Скрипт читает колонку "ДатаБезВремени" и берет дату из первой строки данных (не из шапки)
2. **Фильтрация по дате**: Обрабатываются только строки, где дата совпадает с датой из первой строки
3. **Обработка каждой строки**: Для каждой отфильтрованной строки:
   - Загружается отчет за указанную дату
   - Временные диапазоны определяются из столбцов "Старт" и "Окончание"
   - Выполняются вычисления метрик
   - Результаты сразу сохраняются в исходный файл

### Использование
```bash
# Новый режим с автоматическим определением даты
python main.py input.xlsx --auto-date-processing

# С дополнительными опциями
python main.py input.xlsx --auto-date-processing --with-skills --no-headless
```

### Структура входного файла
Excel файл должен содержать лист "Отчет" со следующими колонками:
- `ДатаБезВремени` - дата проблемы (формат: DD.MM.YYYY)
- `Номер массовой` - номер массового инцидента
- `Регион` - регион проблемы
- `Старт` - время начала проблемы
- `Окончание` - время окончания проблемы
- Другие колонки...

### Пример входных данных
```
ДатаБезВремени  Номер массовой  Заметки  Название  Регион  Старт  Окончание  Макрорегион  Месяц  Неделя (вс)  Неделя (ISO)
01.08.2025  113156  7  Проблемы с интернетом в г. Корсаков, Невельск, Колхозное, Раздольное  Сахалин  16.07.2025 9:21  00.01.1900 0:00  БиДВ  8  31  31
01.08.2025  113157  8  Другая проблема  Сахалин  16.07.2025 10:30  00.01.1900 0:00  БиДВ  8  31  31
02.08.2025  113158  9  Проблема на другую дату  Москва  17.07.2025 8:15  00.01.1900 0:00  ЦФО  8  32  32
```

### Результат
В исходный Excel файл добавляются новые колонки:
- `Потерянные` - количество потерянных звонков
- `Полученные` - коэффициент превышения трафика

Результаты сохраняются сразу после обработки каждой строки.

### Преимущества нового режима
1. **Автоматизация**: Не нужно вручную указывать дату
2. **Точность**: Обрабатываются только релевантные строки
3. **Эффективность**: Результаты сохраняются сразу, нет потери данных
4. **Удобство**: Один запуск для обработки всех проблем за конкретную дату

### Отличия от стандартного режима
| Параметр | Стандартный режим | Новый режим (--auto-date-processing) |
|----------|-------------------|--------------------------------------|
| Определение даты | Обрабатывает все строки | Автоматически из первой строки |
| Фильтрация | Нет | Только строки с той же датой |
| Временные окна | Разбивает на дневные окна | Одно окно на дату |
| Сохранение результатов | В CSV файл | В исходный Excel файл |
| Колонки результатов | LostCalls, ExcessTraffic | Потерянные, Полученные |

### Тестирование
Для проверки новой функциональности используйте тестовый скрипт:
```bash
python test_auto_date_processing.py
```

### Требования
- Python 3.7+
- pandas
- openpyxl
- selenium
- loguru
- pyyaml

### Конфигурация
Убедитесь, что файл `region_skills.yml` содержит настройки для всех регионов, которые будут обрабатываться.