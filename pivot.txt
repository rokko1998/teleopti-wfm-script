// üíæ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π M‚Äë–∫–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ¬´–°–≤–æ–¥ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º¬ª
// –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π: –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –°—Ç–∞—Ä—Ç/–û–∫–æ–Ω—á–∞–Ω–∏–µ –∏–∑ MassiveIncidents,
// –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
let
// 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Access
–ò—Å—Ç–æ—á–Ω–∏–∫ = Access.Database(File.Contents("\\corp.tele2.ru\zrfolders\CC RTM Group\Escalation\–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏!!!\–ó–∞–º–µ—Ç–∫–∏ –ø–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º\massive_reports.accdb"), [CreateNavigationProperties=true]),

// 2. –ó–∞–ø—Ä–æ—Å ¬´–°–≤–æ–¥ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º¬ª (–∫–∞–∫ –±—ã–ª–æ)
–°–≤–æ–¥              = –ò—Å—Ç–æ—á–Ω–∏–∫{[Schema="", Item="–°–≤–æ–¥ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º"]}[Data],
–°–≤–æ–¥–¢–∏–ø           = Table.TransformColumnTypes(–°–≤–æ–¥, {{"–î–∞—Ç–∞–ë–µ–∑–í—Ä–µ–º–µ–Ω–∏", type date}}),

// 3. Excel‚Äë—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ ¬´–ú–∞—Å—Å–æ–≤—ã–µ_–ø—Ä–æ–±–ª–µ–º—ã¬ª (–Ω–∞–∑–≤–∞–Ω–∏–µ + —Ä–µ–≥–∏–æ–Ω)
–ú–∞—Å—Å–æ–≤—ã–µ–ü—Ä–æ–±–ª–µ–º—ã   = Excel.CurrentWorkbook(){[Name="–ú–∞—Å—Å–æ–≤—ã–µ_–ø—Ä–æ–±–ª–µ–º—ã"]}[Content],
–ú–∞—Å—Å–æ–≤—ã–µ–¢–∏–ø        = Table.TransformColumnTypes(–ú–∞—Å—Å–æ–≤—ã–µ–ü—Ä–æ–±–ª–µ–º—ã, {{"–ù–æ–º–µ—Ä", Int64.Type}}),
–ú–∞—Å—Å–æ–≤—ã–µ–ü–µ—Ä–µ–∏–º     = Table.RenameColumns(–ú–∞—Å—Å–æ–≤—ã–µ–¢–∏–ø, {{"–ù–æ–º–µ—Ä", "–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"}}),

–°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ù–∞–∑–≤–∞–Ω–∏–µ = Table.NestedJoin(
    –°–≤–æ–¥–¢–∏–ø,              {"–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"},
    –ú–∞—Å—Å–æ–≤—ã–µ–ü–µ—Ä–µ–∏–º,       {"–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"},
    "–ù–∞–∑–≤–∞–Ω–∏—è–†–µ–≥–∏–æ–Ω",    JoinKind.LeftOuter
),
–†–∞—Å–∫—Ä—ã—Ç—ã–µ1 = Table.ExpandTableColumn(
    –°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ù–∞–∑–≤–∞–Ω–∏–µ,
    "–ù–∞–∑–≤–∞–Ω–∏—è–†–µ–≥–∏–æ–Ω", {"–ù–∞–∑–≤–∞–Ω–∏–µ", "–†–µ–≥–∏–æ–Ω"}
),

// 4. MassiveIncidents ‚Äì —Ç—è–Ω–µ–º –°—Ç–∞—Ä—Ç –∏ –û–∫–æ–Ω—á–∞–Ω–∏–µ
MassiveRaw   = –ò—Å—Ç–æ—á–Ω–∏–∫{[Schema="", Item="MassiveIncidents"]}[Data],

// 4.1 –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—É—é –∫–æ–ª–æ–Ω–∫—É ¬´–°—Ç–∞—Ä—Ç¬ª –∏–∑ —Ç–µ–∫—Å—Ç–∞ ¬´–ß—Ç–æ_–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç¬ª
MassiveAddStart = Table.AddColumn(
    MassiveRaw, "–°—Ç–∞—Ä—Ç",
    each let
            txt     = Text.From([–ß—Ç–æ_–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç], "ru-RU"),
            digits  = Text.Select(txt, {"0".."9"}),
            core12  = if Text.Length(digits) >= 12 then Text.Start(digits, 12) else null,
            formatted = if core12 <> null then
                Text.Combine({
                    Text.Start(core12,2), ".", Text.Range(core12,2,2), ".", Text.Range(core12,4,4), " ",
                    Text.Range(core12,8,2), ":", Text.Range(core12,10,2)
                }) else null
        in
            try DateTime.From(formatted) otherwise null,
    type datetime
),

MassiveTyped = Table.TransformColumnTypes(
    MassiveAddStart,
    {{"–ù–æ–º–µ—Ä", Int64.Type}, {"–°—Ç–∞—Ä—Ç", type datetime}, {"–û–∫–æ–Ω—á–∞–Ω–∏–µ", type datetime}}
),
MassiveRenamed = Table.RenameColumns(MassiveTyped, {{"–ù–æ–º–µ—Ä", "–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"}}),

// 4.2 Join —Å —Ç–∞–±–ª–∏—Ü–µ–π –≤—ã—à–µ
–°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ü–µ—Ä–∏–æ–¥–æ–º = Table.NestedJoin(
    –†–∞—Å–∫—Ä—ã—Ç—ã–µ1,           {"–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"},
    MassiveRenamed,       {"–ù–æ–º–µ—Ä –º–∞—Å—Å–æ–≤–æ–π"},
    "–ü–µ—Ä–∏–æ–¥",             JoinKind.LeftOuter
),
–†–∞—Å–∫—Ä—ã—Ç—ã–µ–ü–µ—Ä–∏–æ–¥ = Table.ExpandTableColumn(
    –°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ü–µ—Ä–∏–æ–¥–æ–º,
    "–ü–µ—Ä–∏–æ–¥", {"–°—Ç–∞—Ä—Ç", "–û–∫–æ–Ω—á–∞–Ω–∏–µ"}
),

// 5. –ú–∞–∫—Ä–æ—Ä–µ–≥–∏–æ–Ω—ã
–ú–∞–∫—Ä–æ–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ = Excel.CurrentWorkbook(){[Name="—Ä_–º—Ä"]}[Content],
–ú–∞–∫—Ä–æ–¢–∏–ø        = Table.TransformColumnTypes(–ú–∞–∫—Ä–æ–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫, {{"—Ä–µ–≥–∏–æ–Ω", type text}, {"–º—Ä", type text}}),

–°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ú–∞–∫—Ä–æ = Table.NestedJoin(
    –†–∞—Å–∫—Ä—ã—Ç—ã–µ–ü–µ—Ä–∏–æ–¥, {"–†–µ–≥–∏–æ–Ω"},
    –ú–∞–∫—Ä–æ–¢–∏–ø,       {"—Ä–µ–≥–∏–æ–Ω"},
    "–ú–∞–∫—Ä–æ",        JoinKind.LeftOuter
),
–†–∞—Å–∫—Ä—ã—Ç—ã–µ2 = Table.ExpandTableColumn(–°–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–ú–∞–∫—Ä–æ, "–ú–∞–∫—Ä–æ", {"–º—Ä"}),

// 6. –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
–î–æ–±–∞–≤–ª–µ–Ω–ú–µ—Å—è—Ü      = Table.AddColumn(–†–∞—Å–∫—Ä—ã—Ç—ã–µ2, "–ú–µ—Å—è—Ü", each Date.Month([–î–∞—Ç–∞–ë–µ–∑–í—Ä–µ–º–µ–Ω–∏]), Int64.Type),
–î–æ–±–∞–≤–ª–µ–Ω–∞–ù–µ–¥–µ–ª—è–í–°  = Table.AddColumn(–î–æ–±–∞–≤–ª–µ–Ω–ú–µ—Å—è—Ü, "–ù–µ–¥–µ–ª—è (–≤—Å)", each Date.WeekOfYear([–î–∞—Ç–∞–ë–µ–∑–í—Ä–µ–º–µ–Ω–∏]), Int64.Type),
–î–æ–±–∞–≤–ª–µ–Ω–∞–ù–µ–¥–µ–ª—èISO = Table.AddColumn(–î–æ–±–∞–≤–ª–µ–Ω–∞–ù–µ–¥–µ–ª—è–í–°, "–ù–µ–¥–µ–ª—è (ISO)", each Date.WeekOfYear([–î–∞—Ç–∞–ë–µ–∑–í—Ä–µ–º–µ–Ω–∏], Day.Monday), Int64.Type),

–ò—Ç–æ–≥ = Table.RenameColumns(–î–æ–±–∞–≤–ª–µ–Ω–∞–ù–µ–¥–µ–ª—èISO, {{"–º—Ä", "–ú–∞–∫—Ä–æ—Ä–µ–≥–∏–æ–Ω"}}),
    #"–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç" = Table.AddColumn(–ò—Ç–æ–≥, "–í—Å–µ–≥–æ –∂–∞–ª–æ–±", each "")

in
#"–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç"